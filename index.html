<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Firebase) ‚Äî ‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏´‡πâ‡∏≠‡∏á/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box}
    :root{ --pri1:#4f46e5; --pri2:#7c3aed; --ok:#2e7d32; --err:#b71c1c; --muted:#6b7280 }
    body{margin:0;font-family:'Kanit','Sarabun',system-ui,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,#4f46e5,#7c3aed);min-height:100svh;color:#0f172a}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{color:#fff;text-align:center;margin-bottom:20px}
    .header h1{margin:0 0 6px;font-size:clamp(1.6rem,2.5vw,2.3rem);text-shadow:2px 2px 12px rgba(0,0,0,.25)}
    .card{background:rgba(255,255,255,.96);backdrop-filter:blur(8px);border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.25);padding:22px}
    .grid{display:grid;gap:18px}
    .tabs{display:flex;gap:6px;background:#fff;border-radius:14px;padding:6px}
    .tab{flex:1;border:0;background:transparent;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(135deg,var(--pri1),var(--pri2));color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-weight:700;margin-bottom:6px;display:block}
    input,select{width:100%;padding:12px;border:2px solid #e6e6ef;border-radius:12px;font-size:15px}
    input:focus,select:focus{outline:none;border-color:var(--pri1);box-shadow:0 0 0 4px rgba(79,70,229,.15)}
    button{border:0;background:linear-gradient(135deg,var(--pri1),var(--pri2));color:#fff;font-weight:800;padding:12px 18px;border-radius:12px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .pill.pending{background:#ffe08a;color:#7a5200}
    .pill.submitted{background:#d6ecff;color:#0a4a8b}
    .pill.approved{background:#c8f7cf;color:#0a6b2b}
    .pill.rejected{background:#ffd6db;color:#7b1524}
    .status-legend{display:flex;gap:8px;flex-wrap:wrap}
    .day-card{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
    .muted{color:var(--muted)}
    .list{background:rgba(255,255,255,.2);border-radius:12px;padding:8px 10px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:8px 2px;border-bottom:1px solid rgba(255,255,255,.3)}
    .item:last-child{border-bottom:0}
    .upload{border:2px dashed var(--pri1);border-radius:14px;padding:30px;text-align:center;cursor:pointer}
    .upload:hover{background:rgba(79,70,229,.08)}
    .preview{max-width:100%;max-height:280px;border-radius:10px;display:none;margin-top:10px}
    .review-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
    .review-card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.12)}
    .review-actions{display:flex;gap:8px;margin-top:10px}
    .btn-green{background:linear-gradient(135deg,#4caf50,#2e7d32)}
    .btn-red{background:linear-gradient(135deg,#f44336,#b71c1c)}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .topbar small{color:#fff;opacity:.9}
    @media (max-width: 920px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <p>‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏´‡πâ‡∏≠‡∏á / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‚Äî ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Firebase ‡∏à‡∏£‡∏¥‡∏á</p>
    </div>

    <!-- Auth -->
    <div id="auth" class="card">
      <div class="grid">
        <h2 style="margin:0">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
        <div class="row">
          <div>
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="email" type="email" placeholder="you@example.com" />
          </div>
          <div>
            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input id="password" type="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å)</label>
            <input id="fullName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î.‡∏ä. ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" />
          </div>
          <div>
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
            <select id="role">
              <option value="student">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
              <option value="teacher">‡∏Ñ‡∏£‡∏π/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <input id="school" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡∏™‡∏≤‡∏£" />
          </div>
          <div>
            <label>‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</label>
            <input id="classroom" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/3" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á)</label>
            <input id="studentNo" type="number" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15" />
          </div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button id="btnSignIn" style="width:100%">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button id="btnSignUp" class="btn-green" style="width:100%">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
        <div class="status-legend">
          <div class="pill pending">‡∏£‡∏≠‡∏™‡πà‡∏á</div>
          <div class="pill submitted">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>
          <div class="pill approved">‡∏ú‡πà‡∏≤‡∏ô</div>
          <div class="pill rejected">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</div>
        </div>
        <small id="authMsg"></small>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="grid" style="display:none;margin-top:16px">
      <div class="topbar">
        <div style="color:#fff">
          <div id="welcome" style="font-weight:800"></div>
          <small id="roleText"></small>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnSignOut">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <!-- Student UI -->
      <div id="studentUI" class="card" style="display:none">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="myDuties">‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
          <button class="tab" data-tab="submitWork">‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button>
        </div>
        <div id="myDuties" class="grid">
          <h3>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
          <div id="studentDutyList" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))"></div>
        </div>
        <div id="submitWork" class="grid" style="display:none">
          <h3>üì§ ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
          <div>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏£</label>
            <select id="dutyDaySelect"></select>
          </div>
          <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</label>
          <div class="upload" id="uploadBox">
            <input id="photoInput" type="file" accept="image/*" style="display:none" />
            <div>üì∑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</div>
            <img id="preview" class="preview" />
          </div>
          <div>
            <button id="btnSubmitWork" disabled>‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button>
            <small id="submitMsg"></small>
          </div>
        </div>
      </div>

      <!-- Teacher UI -->
      <div id="teacherUI" class="card" style="display:none">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£</button>
          <button class="tab" data-tab="review">‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</button>
          <button class="tab" data-tab="reports">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>
        <div id="manage" class="grid">
          <h3>üìã ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h3>
          <div class="row">
            <div>
              <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
              <select id="studentSelect"></select>
            </div>
            <div>
              <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label>
              <select id="daySelect">
                <option value="monday">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                <option value="tuesday">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                <option value="wednesday">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò</option>
                <option value="thursday">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                <option value="friday">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
              </select>
            </div>
          </div>
          <div>
            <button id="btnAssign">üìå ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</button>
            <small id="assignMsg"></small>
          </div>
          <h3 style="margin-top:16px">üóìÔ∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h3>
          <div id="schedule" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr))"></div>
          <h3 style="margin-top:16px">üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <div id="summary" class="grid"></div>
        </div>

        <div id="review" class="grid" style="display:none">
          <h3>‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
          <div id="reviewList" class="review-grid"></div>
        </div>

        <div id="reports" class="grid" style="display:none">
          <h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr))">
            <div class="day-card"><div>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div><div id="statPending" style="font-size:38px;font-weight:800">0</div></div>
            <div class="day-card"><div>‡∏ú‡πà‡∏≤‡∏ô</div><div id="statApproved" style="font-size:38px;font-weight:800">0</div></div>
            <div class="day-card"><div>‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</div><div id="statRejected" style="font-size:38px;font-weight:800">0</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, onSnapshot, query, where, arrayUnion, arrayRemove, writeBatch, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyB0RRS4QLaYhsiW_uImTzOJUpcAWmMHr2A',
      authDomain: 'bss-8950d.firebaseapp.com',
      projectId: 'bss-8950d',
      storageBucket: 'bss-8950d.firebasestorage.app',
      messagingSenderId: '343733507437',
      appId: '1:343733507437:web:8d1c6e4315f25e8fdab664',
      measurementId: 'G-X611D447KQ'
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const dayNames = { monday:'‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', tuesday:'‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', wednesday:'‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò', thursday:'‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', friday:'‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå' };
    const $ = sel => document.querySelector(sel);
    const toast = (el, msg, ok=true) => { el.textContent = msg; el.style.color = ok ? '#2e7d32' : '#b71c1c'; setTimeout(()=> el.textContent='', 3500); };
    const pill = (status) => `<span class="pill ${status}">` + (status==='pending'?'‡∏£‡∏≠‡∏™‡πà‡∏á': status==='submitted'?'‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à': status==='approved'?'‡∏ú‡πà‡∏≤‡∏ô':'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô') + '</span>';

    // ===== Auth Inputs =====
    const emailEl = $('#email');
    const passwordEl = $('#password');
    const fullNameEl = $('#fullName');
    const roleEl = $('#role');
    const schoolEl = $('#school');
    const classEl = $('#classroom');
    const noEl = $('#studentNo');
    const authMsg = $('#authMsg');

    $('#btnSignUp').addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pass = passwordEl.value;
      const fullName = fullNameEl.value.trim();
      const role = roleEl.value;
      const school = schoolEl.value.trim();
      const classroom = classEl.value.trim();
      const studentNo = noEl.value ? Number(noEl.value) : null;
      if(!email || !pass || !fullName){ return toast(authMsg,'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö',false) }
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(cred.user,{ displayName: fullName });
        await setDoc(doc(db,'users',cred.user.uid),{ fullName, role, email, school, classroom, studentNo, createdAt: serverTimestamp() });
        toast(authMsg,'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî');
      }catch(e){ toast(authMsg,e.message,false) }
    });

    $('#btnSignIn').addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const pass = passwordEl.value;
      if(!email || !pass){ return toast(authMsg,'‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',false) }
      try{ await signInWithEmailAndPassword(auth,email,pass); }
      catch(e){ toast(authMsg,'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,false) }
    });

    $('#btnSignOut').addEventListener('click', () => signOut(auth));

    // Tabs
    function bindTabs(scope){
      scope.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const target = btn.dataset.tab;
          scope.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          scope.querySelectorAll('[id]').forEach(sec=>{
            if(['myDuties','submitWork','manage','review','reports'].includes(sec.id)){
              sec.style.display = sec.id===target ? '' : 'none';
            }
          })
        })
      })
    }
    bindTabs($('#studentUI'));
    bindTabs($('#teacherUI'));

    // Data model
    // users/{uid} -> { fullName, role, email, school, classroom, studentNo }
    // schedules/regular -> { monday: [uid], ... }
    // submissions/{autoId} -> { studentUid, studentName, school, classroom, studentNo, day, photoURL, status, submittedAt }

    async function ensureScheduleDoc(){
      const ref = doc(db,'schedules','regular');
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref,{ monday:[], tuesday:[], wednesday:[], thursday:[], friday:[] });
      }
      return ref;
    }

    // ===== Student UI =====
    const dutyDaySelect = $('#dutyDaySelect');
    const previewImg = $('#preview');
    const photoInput = $('#photoInput');
    const uploadBox = $('#uploadBox');
    const submitMsg = $('#submitMsg');

    uploadBox.addEventListener('click',()=> photoInput.click());
    photoInput.addEventListener('change',()=>{
      const f = photoInput.files?.[0];
      if(f){
        const reader = new FileReader();
        reader.onload = e=>{ previewImg.src = e.target.result; previewImg.style.display='block'; $('#btnSubmitWork').disabled = !dutyDaySelect.value }
        reader.readAsDataURL(f);
      }
    });

    dutyDaySelect.addEventListener('change',()=>{ $('#btnSubmitWork').disabled = !(dutyDaySelect.value && photoInput.files?.length) });

    $('#btnSubmitWork').addEventListener('click', async ()=>{
      const user = auth.currentUser; if(!user) return;
      const day = dutyDaySelect.value; const file = photoInput.files?.[0];
      if(!day || !file) return;
      try{
        const u = (await getDoc(doc(db,'users',user.uid))).data()||{};
        const path = `submissions/${user.uid}/${Date.now()}_${file.name}`;
        const ref = sRef(storage,path);
        await uploadBytes(ref,file);
        const url = await getDownloadURL(ref);
        await addDoc(collection(db,'submissions'),{
          studentUid: user.uid,
          studentName: u.fullName || user.displayName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
          school: u.school || '', classroom: u.classroom || '', studentNo: u.studentNo || null,
          day, photoURL: url, status: 'submitted', submittedAt: serverTimestamp()
        });
        dutyDaySelect.value=''; photoInput.value=''; previewImg.style.display='none';
        toast(submitMsg,'‡∏™‡πà‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à) ‚úî');
      }catch(e){ toast(submitMsg,'‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,false) }
    });

    async function loadStudentDuties(uid){
      const ref = await ensureScheduleDoc();
      const sched = (await getDoc(ref)).data();
      const myDays = Object.keys(dayNames).filter(d=> (sched[d]||[]).includes(uid));
      const container = $('#studentDutyList');
      container.innerHTML='';
      if(myDays.length===0){ container.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</div>'; }
      const u = (await getDoc(doc(db,'users',uid))).data()||{};
      for(const d of myDays){
        const qSnap = await getDocs(query(collection(db,'submissions'), where('studentUid','==',uid), where('day','==',d)));
        let status = 'pending';
        qSnap.forEach(s=>{ status = s.data().status });
        const card = document.createElement('div');
        card.className='day-card';
        card.innerHTML = `<h3>${dayNames[d]}</h3>
          <div class="list">
            <div class="item"><div>
              <div style="font-weight:800">${u.fullName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
              <div style="font-size:12px;opacity:.95">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${u.school||'-'} | ‡∏´‡πâ‡∏≠‡∏á: ${u.classroom||'-'} | ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${u.studentNo||'-'}</div>
            </div><div>${pill(status)}</div></div>
          </div>`;
        container.appendChild(card);
      }
      dutyDaySelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏£ --</option>';
      myDays.forEach(d=>{
        const opt = document.createElement('option'); opt.value=d; opt.textContent=dayNames[d]; dutyDaySelect.appendChild(opt);
      })
    }

    // ===== Teacher UI =====
    const studentSelect = $('#studentSelect');
    const daySelect = $('#daySelect');
    const assignMsg = $('#assignMsg');

    $('#btnAssign').addEventListener('click', async ()=>{
      const uid = studentSelect.value; const day = daySelect.value; if(!uid) return toast(assignMsg,'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô',false);
      try{
        const ref = await ensureScheduleDoc();
        await updateDoc(ref,{ [day]: arrayUnion(uid) });
        toast(assignMsg,'‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî');
        await renderSchedule();
        await renderSummary();
      }catch(e){ toast(assignMsg,'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,false)}
    });

    async function removeDuty(day, uid){
      await updateDoc(await ensureScheduleDoc(),{ [day]: arrayRemove(uid) });
      await renderSchedule(); await renderSummary();
    }

    function decorateStudentLabel(d){
      const base = d.fullName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const tail = [d.classroom?`‡∏´‡πâ‡∏≠‡∏á ${d.classroom}`:null, d.studentNo?`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${d.studentNo}`:null].filter(Boolean).join(' ‚Ä¢ ');
      return tail? `${base} ‚Äî ${tail}` : base;
    }

    async function listStudents(){
      const snap = await getDocs(query(collection(db,'users'), where('role','==','student')));
      studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
      const items = [];
      snap.forEach(d=>{ const data=d.data(); items.push({uid:d.id, ...data}) });
      items.sort((a,b)=> (a.classroom||'').localeCompare(b.classroom||'', 'th') || (a.studentNo||0)-(b.studentNo||0));
      items.forEach(s=>{ const op=document.createElement('option'); op.value=s.uid; op.textContent=decorateStudentLabel(s); studentSelect.appendChild(op) });
      return Object.fromEntries(items.map(s=>[s.uid,s]));
    }

    async function renderSchedule(){
      const container = $('#schedule'); container.innerHTML='';
      const sched = (await getDoc(await ensureScheduleDoc())).data();
      const studentMap = await listStudents();
      for(const d of Object.keys(dayNames)){
        const card = document.createElement('div'); card.className='day-card';
        const arr = sched[d]||[];
        const inner = arr.length? arr.map(uid=>{
          const sv = studentMap[uid];
          const n = sv?.fullName || uid;
          const line2 = `‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${sv?.school||'-'} | ‡∏´‡πâ‡∏≠‡∏á: ${sv?.classroom||'-'} | ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${sv?.studentNo||'-'}`;
          return `<div class="item"><div><strong>${n}</strong><div style="font-size:12px;opacity:.95">${line2}</div><div class=\"muted\" style=\"font-size:12px\">‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏∏‡∏Å${dayNames[d]}</div></div><div><button class="btn-red" data-remove="${d}|${uid}" style="padding:6px 10px">‡∏•‡∏ö</button></div></div>`
        }).join('') : `<div class="muted" style="padding:6px 0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ</div>`;
        card.innerHTML = `<h3 style="margin:0 0 8px">${dayNames[d]} <span class="muted" style="font-size:12px">(${arr.length} ‡∏Ñ‡∏ô)</span></h3><div class="list">${inner}</div>`;
        container.appendChild(card);
      }
      container.querySelectorAll('button[data-remove]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const [d,uid] = btn.dataset.remove.split('|');
          if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏ß‡∏£‡∏ô‡∏µ‡πâ?')) await removeDuty(d,uid);
        })
      })
    }

    async function renderSummary(){
      const container = $('#summary'); container.innerHTML='';
      const sched = (await getDoc(await ensureScheduleDoc())).data();
      const studentMap = await listStudents();
      const map = {};
      for(const d of Object.keys(dayNames)){
        (sched[d]||[]).forEach(uid=>{ map[uid] = map[uid] || []; map[uid].push(dayNames[d]); })
      }
      const entries = Object.entries(map).sort((a,b)=>{
        const A = studentMap[a[0]]||{}; const B = studentMap[b[0]]||{};
        return (A.classroom||'').localeCompare(B.classroom||'','th') || (A.studentNo||0)-(B.studentNo||0);
      });
      if(entries.length===0){ container.innerHTML='<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏£</div>'; return }
      entries.forEach(([uid,days])=>{
        const s = studentMap[uid]||{};
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <strong>${s.fullName||uid}</strong>
            <div class="muted" style="font-size:12px">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.school||'-'} | ‡∏´‡πâ‡∏≠‡∏á: ${s.classroom||'-'} | ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${s.studentNo||'-'}</div>
            <div class="muted" style="font-size:12px">üìÖ ‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥: ${days.join(', ')}</div>
          </div>
          <button class="btn-red" data-removeall="${uid}">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>`;
        container.appendChild(div);
      })
      container.querySelectorAll('[data-removeall]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const uid = btn.dataset.removeall;
          if(!confirm('‡∏•‡∏ö‡πÄ‡∏ß‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) return;
          const ref = await ensureScheduleDoc();
          const snap = await getDoc(ref); const data = snap.data();
          const batch = writeBatch(db);
          for(const d of Object.keys(dayNames)){
            if((data[d]||[]).includes(uid)){
              const arr = (data[d]||[]).filter(x=>x!==uid); batch.update(ref,{ [d]: arr });
            }
          }
          await batch.commit(); await renderSchedule(); await renderSummary();
        })
      })
    }

    function attachReviewRealtime(){
      return onSnapshot(query(collection(db,'submissions'), where('status','==','submitted')),(snap)=>{
        const list = $('#reviewList'); list.innerHTML='';
        if(snap.empty){ list.innerHTML='<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>'; }
        snap.forEach(docu=>{
          const d = docu.data();
          const id = docu.id;
          const card = document.createElement('div'); card.className='review-card';
          const meta = [d.school?`‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${d.school}`:null, d.classroom?`‡∏´‡πâ‡∏≠‡∏á ${d.classroom}`:null, d.studentNo?`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${d.studentNo}`:null].filter(Boolean).join(' ‚Ä¢ ');
          card.innerHTML = `<h4 style="margin:0 0 6px">${d.studentName}</h4>
            <div class="muted" style="font-size:13px">${meta || ''}</div>
            <div class="muted" style="font-size:13px">‡∏ß‡∏±‡∏ô: ${dayNames[d.day]||d.day}</div>
            <img src="${d.photoURL}" style="width:100%;max-height:220px;object-fit:cover;border-radius:10px;margin:10px 0" />
            <div class="review-actions">
              <button class="btn-green" data-approve="${id}">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ú‡πà‡∏≤‡∏ô)</button>
              <button class="btn-red" data-reject="${id}">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</button>
            </div>`;
          list.appendChild(card);
        });
        list.querySelectorAll('[data-approve]').forEach(b=> b.addEventListener('click',()=> updateDoc(doc(db,'submissions',b.dataset.approve),{status:'approved'})) );
        list.querySelectorAll('[data-reject]').forEach(b=> b.addEventListener('click',()=>{
          const reason = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô:');
          if(reason!=null){ updateDoc(doc(db,'submissions',b.dataset.reject),{status:'rejected', rejectReason: reason}) }
        }));
      })
    }

    async function renderStats(){
      const p = await getDocs(query(collection(db,'submissions'), where('status','==','submitted')));
      const a = await getDocs(query(collection(db,'submissions'), where('status','==','approved')));
      const r = await getDocs(query(collection(db,'submissions'), where('status','==','rejected')));
      $('#statPending').textContent = p.size; $('#statApproved').textContent = a.size; $('#statRejected').textContent = r.size;
    }

    let unsubReview = null;
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ $('#app').style.display='none'; $('#auth').style.display='block'; return; }
      const userDoc = await getDoc(doc(db,'users',user.uid));
      const u = userDoc.exists()? userDoc.data() : { fullName: user.displayName || user.email, role:'student' };
      $('#auth').style.display='none'; $('#app').style.display='grid';
      $('#welcome').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${u.fullName}${u.classroom?` (‡∏´‡πâ‡∏≠‡∏á ${u.classroom}${u.studentNo?` ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${u.studentNo}`:''})`:''}`;
      $('#roleText').textContent = `‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${u.role==='teacher'?'‡∏Ñ‡∏£‡∏π/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á':'‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'}${u.school?` ‚Ä¢ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${u.school}`:''}`;

      if(u.role==='student'){
        $('#studentUI').style.display='block'; $('#teacherUI').style.display='none';
        await loadStudentDuties(user.uid);
      } else {
        $('#studentUI').style.display='none'; $('#teacherUI').style.display='block';
        await listStudents(); await renderSchedule(); await renderSummary();
        if(unsubReview) unsubReview(); unsubReview = attachReviewRealtime();
        await renderStats();
      }
    });
  </script>

  <!-- Firestore Rules (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Console > Firestore Rules)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn() { return request.auth != null; }
      function isTeacher(uid) { return get(/databases/$(database)/documents/users/$(uid)).data.role == 'teacher'; }

      match /users/{uid} {
        allow read: if isSignedIn();
        allow write: if request.auth.uid == uid || isTeacher(request.auth.uid);
      }

      match /schedules/{docId} {
        allow read: if isSignedIn();
        allow write: if isTeacher(request.auth.uid);
      }

      match /submissions/{id} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.studentUid == request.auth.uid;
        allow update, delete: if isTeacher(request.auth.uid);
      }
    }
  }
  -->

  <!-- Storage Rules (Console > Storage > Rules)
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      function isSignedIn() { return request.auth != null; }
      match /submissions/{userId}/{allPaths=**} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && request.auth.uid == userId;
      }
    }
  }
  -->
</body>
</html>
